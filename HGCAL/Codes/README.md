# HGCAL Simulation Pipeline

This repository contains a complete pipeline for High Granularity Calorimeter (HGCAL) simulation, from pileup generation through digitisation and validation.

## Directory Structure

```
Codes/
├── PileupUtils/
│   ├── createPileupFile.C
│   ├── PileupAutomation.C
│   └── rootToText.C
│
├── Segmentation/
│   ├── cellwise_segmentation.C
│   ├── automation.C
│   └── job.sh
│
├── SignalToPileupAddition/
│   └── addPileupToSignal.C
│
└── SimhitFilter/
    ├── filter.C
    ├── filter_automation.C
    ├── job.sh
    └── Validation/
        ├── simhitMatrix.C
        └── digihitMatrix.C
```

## Module Descriptions

### 1. PileupUtils

Utilities for generating and managing pileup events for simulation.

#### `createPileupFile.C`
Takes ROOT files generated by Geant4 after simulating pileup. Creates nEvents, each containing nPU pileups for use in subsequent simulations.

#### `PileupAutomation.C`
Automates the `createPileupFile.C` workflow in HPC.

#### `rootToText.C`
Converts Pythia-generated pileup information (root file) into a text format that can be fed into Geant4 during HGCAL simulation.

---

### 2. Segmentation

Handles the digitisation of Geant4 simulation outputs.

#### `cellwise_segmentation.C`
Processes Geant4 output files and produces digitised files containing:
- Pixel-wise cellwise segmentation tree
- η-φ (eta-phi) cellwise segmentation tree

This represents the transformation from continuous energy deposits to discrete detector cells.

#### `automation.C`
Automates the segmentation process through HPC.

#### `job.sh`
HPC job submission script for running segmentation tasks on the cluster.

---

### 3. SignalToPileupAddition

Combines signal and pileup events to simulate realistic detector conditions.

#### `addPileupToSignal.C`
Merges two input files:
- A signal file (physics event of interest)
- A pileup file containing nPU pileup events

Produces an output file with an η-φ tree representing the combined signal plus pileup scenario.

---

### 4. SimhitFilter

Filters and validates Geant4 simulation outputs.

#### `filter.C`
Processes large Geant4 output files and retains only entries with energy deposits greater than 10 eV. This significantly reduces file sizes while preserving the relevant information.

#### `filterAutomation.C`
Automates the filtering process for batch processing through HPC systems.

#### `job.sh`
HPC job submission script for running filter tasks on the cluster.

#### Validation/

Validation tools to ensure filtering code.

##### `simhitMatrix.C`
Generates a table showing event-versus-layer energy deposit from the simulation hit level. Used to compare filtered versus raw Geant4 outputs and validate that the filtering process preserves energy deposit information correctly.

##### `digihitMatrix.C`
Generates a similar event-versus-layer energy deposit table from segmented (digitised) ROOT files. Compares filtered and raw outputs at the digitisation level to validate the complete processing chain.

---

## Workflow Overview

1. **Pileup Generation** (PileupUtils): Generate pileup events from Pythia/Geant4
2. **Filtering** (SimhitFilter): Reduce Geant4 output size by energy threshold
3. **Validation** (SimhitFilter/Validation): Verify filtered output preserves physics
4. **Segmentation** (Segmentation): Digitise simulation hits to detector cells
5. **Signal+Pileup** (SignalToPileupAddition): Combine physics signal with pileup

---

## Requirements

- ROOT (CERN Data Analysis Framework)
- Geant4
- HPC cluster access with job scheduler
- Pythia (for pileup generation)

